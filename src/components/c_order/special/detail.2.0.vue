<template>
    <div class="virtual-detail">

        <jkc-breadcrumb :crumbs="crumbs" :goBack="-1"></jkc-breadcrumb>

        <h1 class="detail-title">订单号：{{ orderDetailData.orderId }}</h1>

        <div class="steps-wrap">
            <el-steps space="25%" :active="processes.len" finish-status="success" :align-center="true" :center="true">
                <el-step description="下单" :title="processes.steps[0]"></el-step>
                <el-step description="付款" :title="processes.steps[1]"></el-step>
                <el-step description="发货" :title="processes.steps[2]"></el-step>
                <el-step description="完成" :title="processes.steps[3]"></el-step>
            </el-steps>
        </div>

        <order-item order-name="special" :order-item-data="orderDetailData" isDetail></order-item>
        
        <!--<div class="statistics">
            <span>运费：￥{{ orderDetailData.shippingFee }}</span>
            <span>总实付价格：￥{{ orderDetailData.realAmount }}</span>
        </div>-->

        <h1 class="detail-title" style="margin-top: 30px;">订单信息</h1>
        <div class="detail-wrap">
            <detail-block 
                :label-width="84"
                :block-static="selfDetailItem.block_first"
                :block-data="orderDetailData">
            </detail-block>
        </div>
        
        <h1 class="detail-title">收货人信息</h1>
        <div class="detail-wrap">
            <detail-block 
                :label-width="70"
                :block-static="selfDetailItem.block_second"
                :block-data="orderDetailData">
            </detail-block>
        </div>
        
        <h1 class="detail-title">物流信息</h1>
        <div class="detail-wrap">
            <detail-block 
                :label-width="70"
                :block-static="selfDetailItem.block_third"
                :block-data="orderDetailData">
            </detail-block>
        </div>
        
        <h1 class="detail-title">订单跟踪信息</h1>
        <el-table :data="orderDetailData.orderLogs" stripe>
            <el-table-column label="操作时间" prop="createdTime"></el-table-column>
            <el-table-column label="操作人" prop="sourceName"></el-table-column>
            <el-table-column label="处理信息" prop="content"></el-table-column>
            <el-table-column label="状态" prop="stateName"></el-table-column>
        </el-table>
        
        <order-delivery></order-delivery>
        
    </div>
</template>

<script>
    
    import JkcBreadcrumb from '../../common/jkc-breadcrumb.vue'
    import OrderItem from '../common/order-item.vue'
    import DetailBlock from '../common/detail-block.vue'
    import OrderDelivery from '../common/order-delivery.vue'
    
    import { pubObj, bus } from '../../../assets/unit/public.js'
//  import api from '../../../assets/config/m-api.js'
    import { common_detail__item, special_detail__item } from '../../../assets/staticData/order.2.0.js'
    
//  import DeliveryForm from '../common/delivery_form.vue'
//  import { mixin_breadcrumb } from '../../common/jkc-mixin.vue'
//  import { router } from '../../../main.js'

    export default {
        components: { JkcBreadcrumb, OrderItem, DetailBlock, OrderDelivery },
        data() {
            return {
                crumbs: [],
                processes: {
                    steps: [null, null, null, null]
                },
                orderDetailData: {},
                selfDetailItem: {},
                blockFourthData: {}
            }
        },
        created() {
            this.crumbs = [{
                title: '订单管理'
            }, {
                title: '行销商品订单',
                to: '/c_order/special'
            }, {
                title: '详情'
            }];
            this.selfDetailItem = this.deepCopyObject(
                JSON.parse(JSON.stringify(common_detail__item)), 
                JSON.parse(JSON.stringify(special_detail__item)), 
            );
        },
        beforeMount() {
            pubObj.httpRequest(this, {
                url: this.$api.order + 'process/' + this.$route.query.orderSid,
                success(result) {
                    const process = result.data.process;
                    const time = result.data.time;
                    
                    this.processes.len = process.length;
                    this.processes.state = result.data.state;
                    
                    process.forEach((item, index) => {
                        this.processes.steps[index] = item.createdTime;
                    })
                    time.forEach((item, index) => {
                        this.$set(this.blockFourthData, this.selfDetailItem.block_fourth[index].prop, item.createdTime)
                    })
                }
            })
        },
        mounted() {
            pubObj.httpRequest(this, {
                url: this.$api.order + 'detail/' + this.$route.query.orderSid,
                headers: { 'api-ver': '2.0.0' },
                success(result) {
                    const sheng = result.data.address.indexOf('省');
                    const shi = result.data.address.indexOf('市');
                    const qu = result.data.address.indexOf('自治区');
                    if(sheng !== -1 || shi !== -1 || qu !== -1) {
                        result.data.fullAddress = result.data.address;
                    } else {
                        result.data.fullAddress = result.data.mergerName + ' ' + result.data.address;
                    }
                    this.orderDetailData = result.data;
                }
            })
        },
        beforeDestroy() { bus.$off(); },
        methods: {
            // 深拷贝
            deepCopyObject(com, spe) {
                const new_block_first = com.block_first.concat(spe.block_first);
                com.block_first = new_block_first;
                const tempObj = Object.assign({}, com);
                return JSON.parse(JSON.stringify(tempObj));
            },
//          handleDelivery(orderId) {
//              bus.$emit('open-delivery-dialog', orderId)
//          }
        }
    }
</script>

<style>
    .virtual-detail .steps-wrap {
        position: relative; width: 60%; margin: auto; padding: 20px 0;
    }
    .virtual-detail .steps-wrap .el-steps.is-horizontal { margin-top: 20px; }
    .virtual-detail .steps-wrap .el-step__description {
        position: absolute; width: 72px; text-align: center; top: -25px; left: -22px;
    }
    
    
    .virtual-detail .image-text-wrap {
        position: relative; 
        text-align: center;
        padding: 14px 18px; 
        height: 54px; 
        line-height: 20px;
        box-sizing: content-box;
    }
    .virtual-detail .image-wrap { float: left; width: 54px; height: 54px; }
    .virtual-detail .image-wrap img { width: 100%; height: 100%; vertical-align: top; }
    .virtual-detail .text-wrap { position: relative; margin-left: 64px; height: 100%; }
    .virtual-detail .text-wrap .text {
        text-align: left;
        max-height: 100%;
        line-height: 16px;
        display: -webkit-box; 
        -webkit-box-orient: vertical;   
        -webkit-line-clamp: 2;   
        overflow: hidden;
    }
    
    
    /*.virtual-detail .statistics {
        font-size: 16px; font-weight: bold; margin-top: 16px; text-align: right;
    }
    .virtual-detail .statistics span+span { margin-left: 10px; }*/
    
    
    .virtual-detail .el-table { border-bottom: none; }
    .virtual-detail .el-table th,
    .virtual-detail .el-table td {
        text-align: center;
        border-right: 1px solid #dfe6ec;
        border-bottom: 1px solid #dfe6ec;
    }
    .virtual-detail .el-table td .cell { display: block; padding: 0; }
    
    
    .virtual-detail .detail-wrap {
        margin-top: 20px;
    }
</style>